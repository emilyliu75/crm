{% extends 'base.html' %} {% block content %}
<h2>Send Email</h2>
<form method="post">
  <div class="mb-3">
    <label>Client</label>
    <select class="form-select" name="client" id="client-select" required>
      <option value="" disabled selected>Select a client</option>
      {% for client in clients %}
      <option
        value="{{ client.id }}"
        data-name="{{ client.name }}"
        data-address="{{ client.address }}"
        data-service="{{ client.service }}"
      >
        {{ client.name }} ({{ client.email }}) üìù {{ client.service }} | üìç{{
        client.address }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label>Template</label>
    <select
      class="form-select"
      name="template"
      required
      onchange="updatePreview()"
      id="template-select"
    >
      <option value="" disabled selected>Select a template</option>
      {% for tpl in templates %}
      <option
        value="{{ tpl.id }}"
        data-subject="{{ tpl.subject }}"
        data-body="{{ tpl.body | e }}"
      >
        {{ tpl.name }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label>Subject</label>
    <input class="form-control" name="subject" id="subject" required />
  </div>
  <div class="mb-3">
    <label>Message</label>
    <textarea
      class="form-control"
      name="body"
      id="body"
      rows="6"
      required
    ></textarea>
  </div>
  <!-- Live HTML Preview -->
  <div class="mt-3">
    <label><strong>Live Preview:</strong></label>
    <div
      id="body-preview"
      style="
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 100px;
        background: #f9f9f9;
      "
    ></div>
  </div>
  <button class="btn btn-primary mt-3">Send Email</button>
</form>

{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%} {% for category, msg in messages %}
<div class="alert alert-{{ category }} mt-3">{{ msg }}</div>
{% endfor %} {% endif %} {% endwith %}

<script>
  // Live HTML preview and template autofill logic
  document.addEventListener("DOMContentLoaded", function () {
    const templateSelect = document.getElementById("template-select");
    const subjectInput = document.getElementById("subject");
    const bodyInput = document.getElementById("body");
    const previewDiv = document.getElementById("body-preview");

    function updatePreview() {
      // Render the textarea content as HTML in the preview box
      previewDiv.innerHTML = bodyInput.value;
    }

    // Autofill subject/body from template
    if (templateSelect) {
      templateSelect.addEventListener("change", function () {
        const selected = templateSelect.selectedOptions[0];
        subjectInput.value = selected.dataset.subject || "";
        bodyInput.value = selected.dataset.body || "";
        updatePreview();
      });
    }

    // Update preview as user types
    bodyInput.addEventListener("input", updatePreview);

    // Initialise preview on page load
    updatePreview();
  });
</script>
{% endblock %}
